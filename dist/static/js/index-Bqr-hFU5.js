import{d as Ve,as as Ie,k as f,x as ke,l as P,at as we,z as xe,r as g,b as Ne,c as w,o as m,e as l,i as t,au as qe,u as s,F as C,A as U,h as S,E as V,g as _,f as O,w as R,t as Ce,av as T,aw as Ue,_ as Re}from"./index-DLbSnZ-2.js";import{P as Te,g as De,a as Fe,u as Pe,b as $e,d as ze,e as Be}from"./PerformanceChart-zffAmg22.js";import{d as Z}from"./delete-Ce0TSdK5.js";import{d as Le,a as Me}from"./add-circle-line-CH7bT49i.js";import{d as We}from"./download-CFfJ8-ZW.js";import{d as Ae}from"./search-DMYzPYXy.js";import{d as Oe}from"./refresh-C_2cW1e5.js";import{g as Ee}from"./dept-CNyEMDwu.js";import{g as ee}from"./user-CNETU6zZ.js";import"./index-Bb6yjXMn.js";const Ye={class:"main"},je={class:"header-operation"},Ke={class:"empty-text"},Qe={class:"dialog-footer"},Ge=Ve({__name:"index",setup(He){const{t:n}=Ie.global,$=f(!1),I=f(!1),E=f(!0),D=f([]),Y=f(0),j=f([]),p=f(null),x=f([]),N=f([]),F=new Date().getFullYear(),K=ke(()=>{const a=[];for(let e=F-5;e<=F+2;e++)a.push(e);return a}),Q=[1,2,3,4],d=P({pageNum:1,pageSize:10,userId:void 0,userName:void 0,deptId:void 0,year:void 0,quarter:void 0,beginTime:void 0,endTime:void 0}),o=P({userId:void 0,deptId:void 0,year:F,quarter:Math.ceil((new Date().getMonth()+1)/3),deptScore:0,personalScore:0,totalScore:0,remark:""}),ae=P({userId:[{required:!0,message:n("performance.userRequired"),trigger:"blur"}],deptId:[{required:!0,message:n("performance.deptRequired"),trigger:"blur"}],year:[{required:!0,message:n("performance.yearRequired"),trigger:"blur"}],quarter:[{required:!0,message:n("performance.quarterRequired"),trigger:"blur"}],deptScore:[{required:!0,message:n("performance.deptScoreRequired"),trigger:"blur"}],personalScore:[{required:!0,message:n("performance.personalScoreRequired"),trigger:"blur"}]}),b=P({visible:!1,title:""}),re=[{type:"selection",width:55},{label:n("performance.userName"),prop:"userName",minWidth:120},{label:n("performance.deptName"),prop:"deptName",minWidth:120},{label:n("performance.year"),prop:"year",minWidth:100},{label:n("performance.quarter"),prop:"quarter",minWidth:100,formatter:a=>`第${a.quarter}季度`},{label:n("performance.deptScore"),prop:"deptScore",minWidth:120,formatter:a=>`${a.deptScore.toFixed(2)}`},{label:n("performance.personalScore"),prop:"personalScore",minWidth:120,formatter:a=>`${a.personalScore.toFixed(2)}`},{label:n("performance.totalScore"),prop:"totalScore",minWidth:120,formatter:a=>`${a.totalScore.toFixed(2)}`},{label:n("performance.createTime"),prop:"createTime",minWidth:180},{label:n("performance.updateTime"),prop:"updateTime",minWidth:180},{label:"操作",fixed:"right",width:160,slot:"operation"}],G=f(),z=f(),le=f(),k=async()=>{$.value=!0;try{const a={pageNum:d.pageNum,pageSize:d.pageSize,userId:d.userId,userName:d.userName,deptId:d.deptId,year:d.year,quarter:d.quarter};p.value&&p.value.length===2&&p.value[0]&&p.value[1]&&(a.beginTime=p.value[0],a.endTime=p.value[1]);const e=await De(a);j.value=e.data.rows,Y.value=e.data.total}catch(a){console.error(a)}finally{$.value=!1}},te=async()=>{try{const a=await Ee(),e=i=>{if(!i)return[];const u=Array.isArray(i)?i:[i],v=c=>{if(!c)return null;const h={...c,children:[]};return c.children&&Array.isArray(c.children)&&(h.children=c.children.map(W=>v(W)).filter(Boolean)),h};return u.map(c=>v(c)).filter(Boolean)};x.value=e(a.data),x.value.length===0&&console.error("部门数据为空或格式不正确")}catch(a){console.error("获取部门数据失败:",a),x.value=[]}},oe=a=>{const e=N.value.find(i=>i.userId===a);e&&(o.deptId=e.deptId)},ne=async a=>{if(a.length<2){N.value=[];return}I.value=!0;try{const e=await ee({username:a,pageSize:10,pageNum:1});N.value=e.data.rows}finally{I.value=!1}},de=we(a=>{ne(a)},300),se=async()=>{I.value=!0;try{const a=await ee({pageSize:10,pageNum:1});N.value=a.data.rows}finally{I.value=!1}},B=()=>{o.totalScore=Number((o.deptScore*.7+o.personalScore*.3).toFixed(2))},L=()=>{var a;(a=z.value)==null||a.resetFields(),o.performanceId=void 0,o.userId=void 0,o.deptId=void 0,o.year=F,o.quarter=Math.ceil((new Date().getMonth()+1)/3),o.deptScore=0,o.personalScore=0,o.totalScore=0,o.remark=""},ue=a=>{},M=()=>{d.pageNum=1,k()},ie=()=>{var a;p.value=null,(a=G.value)==null||a.resetFields(),M()},pe=a=>{D.value=a.map(e=>e.performanceId),E.value=!a.length},me=a=>{d.pageSize=a,k()},ce=a=>{d.pageNum=a,k()},fe=()=>{L(),b.visible=!0,b.title="新增绩效",se()},ge=async a=>{L();const e=a.performanceId||D.value[0],i=await Fe(e);Object.assign(o,i.data),b.visible=!0,b.title="修改绩效"},ve=()=>{var a;(a=z.value)==null||a.validate(async e=>{if(e){B();try{o.performanceId?(await Pe(o),T.success("修改成功")):(await $e(o),T.success("新增成功")),b.visible=!1,k()}catch(i){console.error(i)}}})},H=a=>{const e=a||D.value;if(!e.length){T.warning("请选择要删除的数据");return}Ue.confirm("是否确认删除?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await ze(e),k(),T.success("删除成功")}catch(i){console.error(i)}}).catch(()=>{})},be=()=>{const a={pageNum:d.pageNum,pageSize:d.pageSize,userId:d.userId,userName:d.userName,deptId:d.deptId,year:d.year,quarter:d.quarter};p.value&&p.value.length===2&&p.value[0]&&p.value[1]&&(a.beginTime=p.value[0],a.endTime=p.value[1]),Be(a).then(e=>{const i=new Blob([e],{type:"application/vnd.ms-excel"}),u=`performance_${new Date().getTime()}.xlsx`,v=document.createElement("a");v.href=URL.createObjectURL(i),v.download=u,v.click(),URL.revokeObjectURL(v.href)}).catch(e=>{console.error(e),T.error("导出失败")})},ye=()=>{b.visible=!1,L()};return xe(()=>{te().then(()=>{k()})}),(a,e)=>{const i=g("el-input"),u=g("el-form-item"),v=g("el-tree-select"),c=g("el-option"),h=g("el-select"),W=g("el-date-picker"),y=g("el-button"),J=g("el-form"),X=g("el-card"),_e=g("pure-table"),A=g("el-input-number"),he=g("el-dialog"),q=Ne("hasPerm");return m(),w("div",Ye,[l(X,{shadow:"never",class:"search-wrapper"},{default:t(()=>[l(J,{ref_key:"searchFormRef",ref:G,model:d,inline:!0,onKeyup:qe(M,["enter"])},{default:t(()=>[l(u,{label:s(n)("performance.userName"),prop:"userName"},{default:t(()=>[l(i,{modelValue:d.userName,"onUpdate:modelValue":e[0]||(e[0]=r=>d.userName=r),clearable:"",placeholder:"请输入用户名称"},null,8,["modelValue"])]),_:1},8,["label"]),l(u,{label:s(n)("performance.deptName"),prop:"deptId"},{default:t(()=>[l(v,{modelValue:d.deptId,"onUpdate:modelValue":e[1]||(e[1]=r=>d.deptId=r),data:x.value,props:{label:"label",value:"id",children:"children"},placeholder:"请选择部门名称",clearable:"",filterable:"","default-expand-all":!0},null,8,["modelValue","data"])]),_:1},8,["label"]),l(u,{label:s(n)("performance.year"),prop:"year"},{default:t(()=>[l(h,{modelValue:d.year,"onUpdate:modelValue":e[2]||(e[2]=r=>d.year=r),clearable:"",placeholder:"请选择年份"},{default:t(()=>[(m(!0),w(C,null,U(K.value,r=>(m(),S(c,{key:r,label:r,value:r},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),l(u,{label:s(n)("performance.quarter"),prop:"quarter"},{default:t(()=>[l(h,{modelValue:d.quarter,"onUpdate:modelValue":e[3]||(e[3]=r=>d.quarter=r),clearable:"",placeholder:"请选择季度"},{default:t(()=>[(m(),w(C,null,U(Q,r=>l(c,{key:r,label:`第${r}季度`,value:r},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["label"]),l(u,{label:s(n)("performance.createTime"),prop:"dateRange"},{default:t(()=>[l(W,{modelValue:p.value,"onUpdate:modelValue":e[4]||(e[4]=r=>p.value=r),type:"daterange","range-separator":"-","start-placeholder":"开始时间","end-placeholder":"结束时间","value-format":"YYYY-MM-DD",onChange:ue},null,8,["modelValue"])]),_:1},8,["label"]),l(u,null,{default:t(()=>[l(y,{type:"primary",icon:s(V)(s(Ae)),onClick:M},{default:t(()=>e[15]||(e[15]=[_(" 搜索 ")])),_:1,__:[15]},8,["icon"]),l(y,{icon:s(V)(s(Oe)),onClick:ie},{default:t(()=>e[16]||(e[16]=[_(" 重置 ")])),_:1,__:[16]},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),l(X,{shadow:"never",class:"table-wrapper"},{default:t(()=>[O("div",je,[R((m(),S(y,{type:"primary",icon:s(V)(s(Le)),onClick:fe},{default:t(()=>e[17]||(e[17]=[_(" 添加 ")])),_:1,__:[17]},8,["icon"])),[[q,["system:performance:add"]]]),R((m(),S(y,{type:"danger",disabled:E.value,icon:s(V)(s(Z)),onClick:e[5]||(e[5]=()=>H(D.value))},{default:t(()=>e[18]||(e[18]=[_(" 删除 ")])),_:1,__:[18]},8,["disabled","icon"])),[[q,["system:performance:remove"]]]),R((m(),S(y,{type:"warning",icon:s(V)(s(We)),onClick:be},{default:t(()=>e[19]||(e[19]=[_(" 导出 ")])),_:1,__:[19]},8,["icon"])),[[q,["system:performance:export"]]])]),l(_e,{ref_key:"tableRef",ref:le,data:j.value,columns:re,loading:$.value,pagination:{total:Y.value,pageSize:d.pageSize,currentPage:d.pageNum,background:!0,layout:"total, sizes, prev, pager, next, jumper"},onPageSizeChange:me,onPageCurrentChange:ce,onSelectionChange:pe},{operation:t(({row:r})=>[R((m(),S(y,{type:"primary",link:"",icon:s(V)(s(Me)),onClick:Se=>ge(r)},{default:t(()=>e[20]||(e[20]=[_(" 修改 ")])),_:2,__:[20]},1032,["icon","onClick"])),[[q,["system:performance:edit"]]]),R((m(),S(y,{type:"primary",link:"",icon:s(V)(s(Z)),onClick:Se=>H([r.performanceId])},{default:t(()=>e[21]||(e[21]=[_(" 删除 ")])),_:2,__:[21]},1032,["icon","onClick"])),[[q,["system:performance:remove"]]])]),_:1},8,["data","loading","pagination"])]),_:1}),l(Te),l(he,{title:b.title,modelValue:b.visible,"onUpdate:modelValue":e[14]||(e[14]=r=>b.visible=r),width:"600px","append-to-body":""},{footer:t(()=>[O("div",Qe,[l(y,{type:"primary",onClick:ve},{default:t(()=>e[22]||(e[22]=[_("确定")])),_:1,__:[22]}),l(y,{onClick:ye},{default:t(()=>e[23]||(e[23]=[_("取消")])),_:1,__:[23]})])]),default:t(()=>[l(J,{ref_key:"performanceFormRef",ref:z,model:o,rules:ae,"label-width":"100px"},{default:t(()=>[l(u,{label:s(n)("performance.userName"),prop:"userId"},{default:t(()=>[l(h,{modelValue:o.userId,"onUpdate:modelValue":e[6]||(e[6]=r=>o.userId=r),filterable:"",remote:"","remote-method":r=>s(de).start(r),loading:I.value,placeholder:"请输入用户名搜索",onChange:oe},{empty:t(()=>[O("div",Ke,Ce(I.value?"加载中...":"无匹配数据"),1)]),default:t(()=>[(m(!0),w(C,null,U(N.value,r=>(m(),S(c,{key:r.userId,label:r.nickname||r.username,value:r.userId},null,8,["label","value"]))),128))]),_:1},8,["modelValue","remote-method","loading"])]),_:1},8,["label"]),l(u,{label:s(n)("performance.deptName"),prop:"deptId"},{default:t(()=>[l(v,{modelValue:o.deptId,"onUpdate:modelValue":e[7]||(e[7]=r=>o.deptId=r),data:x.value,props:{label:"label",value:"id",children:"children"},placeholder:"请选择部门",filterable:"","default-expand-all":!0,disabled:!o.userId},null,8,["modelValue","data","disabled"])]),_:1},8,["label"]),l(u,{label:s(n)("performance.year"),prop:"year"},{default:t(()=>[l(h,{modelValue:o.year,"onUpdate:modelValue":e[8]||(e[8]=r=>o.year=r),placeholder:"请选择年份"},{default:t(()=>[(m(!0),w(C,null,U(K.value,r=>(m(),S(c,{key:r,label:r,value:r},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),l(u,{label:s(n)("performance.quarter"),prop:"quarter"},{default:t(()=>[l(h,{modelValue:o.quarter,"onUpdate:modelValue":e[9]||(e[9]=r=>o.quarter=r),placeholder:"请选择季度"},{default:t(()=>[(m(),w(C,null,U(Q,r=>l(c,{key:r,label:`第${r}季度`,value:r},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["label"]),l(u,{label:s(n)("performance.deptScore"),prop:"deptScore"},{default:t(()=>[l(A,{modelValue:o.deptScore,"onUpdate:modelValue":e[10]||(e[10]=r=>o.deptScore=r),min:0,max:100,precision:2,step:.5,onChange:B},null,8,["modelValue"])]),_:1},8,["label"]),l(u,{label:s(n)("performance.personalScore"),prop:"personalScore"},{default:t(()=>[l(A,{modelValue:o.personalScore,"onUpdate:modelValue":e[11]||(e[11]=r=>o.personalScore=r),min:0,max:100,precision:2,step:.5,onChange:B},null,8,["modelValue"])]),_:1},8,["label"]),l(u,{label:s(n)("performance.totalScore"),prop:"totalScore"},{default:t(()=>[l(A,{modelValue:o.totalScore,"onUpdate:modelValue":e[12]||(e[12]=r=>o.totalScore=r),min:0,max:100,precision:2,step:.5,disabled:""},null,8,["modelValue"])]),_:1},8,["label"]),l(u,{label:s(n)("performance.remark"),prop:"remark"},{default:t(()=>[l(i,{modelValue:o.remark,"onUpdate:modelValue":e[13]||(e[13]=r=>o.remark=r),type:"textarea",placeholder:"请输入备注"},null,8,["modelValue"])]),_:1},8,["label"])]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])])}}}),da=Re(Ge,[["__scopeId","data-v-f9a4584f"]]);export{da as default};
